# .codex/PR-04.md â€” Engine Traits + DWBaseEngine Skeleton (dwbase-engine)

## Goal
Define the core engine traits and a compile-ready DWBaseEngine orchestrator skeleton.

## Deliverables
In `crates/dwbase-engine`:
- Traits:
  - `StorageEngine`: append, get_by_ids, scan/replay by world+time range, stats
  - `VectorEngine`: upsert vectors, search(top-k) with filters, rebuild hooks
  - `StreamEngine`: publish atoms, subscribe(handle), poll(handle), stop(handle)
  - `Embedder`: embed(payload)->vector (sync or async; pick async w/ feature `tokio`)
  - `Gatekeeper`: check_remember, check_ask, check_world_action
- Core structs:
  - `NewAtom` (worker-submitted fields)
  - `AtomFilter`, `Question`, `Answer`
  - `WorldMeta`, `WorldAction`
  - `DWBaseEngine<S,V,T,G,E>` generic over engines
- Error model:
  - `DwbaseError` with variants: CapabilityDenied, InvalidInput, Storage, Vector, Stream, Internal

## Constraints
- Do not implement full logic yet; provide stubs returning `todo!()` for methods.
- Keep API aligned with spec (remember/ask/observe/replay/manage_world).

## Acceptance Criteria
- Workspace builds.
- Traits compile and are usable by other crates.
