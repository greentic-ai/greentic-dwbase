# .codex/PR-15.md — Performance & Load Testing (DWBase v1)

## Codex Execution Rules
- Stay strictly within performance testing scope.
- Do not refactor production code unless required for instrumentation.
- Prefer black-box and gray-box tests over internal hooks.
- All benchmarks must be reproducible and documented.

## Goal
Add a performance and load-testing suite to validate DWBase v1 performance targets and prevent regressions.

This PR establishes **measurement**, not optimisation.

## Deliverables

### A) Benchmark harness
Create a new crate:
crates/dwbase-bench/

markdown
Copy code

Using:
- `criterion` for micro-benchmarks
- optional `tokio` for async benchmarks (feature-gated)

Benchmarks to implement:
1. `remember_single_atom`
2. `remember_batch_atoms` (e.g. 10, 100, 1k)
3. `ask_hot_path` (recent atoms, reflex index)
4. `ask_vector_path` (ANN enabled)
5. `observe_throughput`
6. `replay_throughput`

Use:
- Sled storage
- Dummy embedder
- Local stream engine

### B) Load test scenarios
Add a `tests/perf/` directory with executable load tests (not criterion):
- sustained remember rate (atoms/sec)
- concurrent ask + remember
- observe fan-out (N subscribers)

These tests should:
- run for a fixed duration (e.g. 10–30s)
- print summary stats (ops/sec, p50/p95 latency)
- be runnable via `cargo test -- --nocapture`

### C) Performance targets as assertions (soft)
Encode expected targets as **warnings**, not hard failures:
- remember p95 < 2ms (local)
- ask hot path p95 < 3ms
- ask full path p95 < 10ms

If targets are exceeded:
- log warning with context
- do not fail CI yet

### D) Documentation
Add:
- `docs/performance.md`
  - how benchmarks are structured
  - how to run locally
  - how to interpret results
  - current known limits

## Constraints
- No swarm/network benchmarks yet (local node only).
- Do not require special hardware.
- Tests must run on CI runners (GitHub-hosted).

## Acceptance Criteria
- `cargo bench -p dwbase-bench` runs successfully.
- `cargo test` includes perf tests (may be ignored on CI if too slow, but documented).
- Performance documentation exists and is accurate.