name: CI
permissions:
  contents: read

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Install greentic tools
        run: |
          cargo install cargo-binstall
          cargo binstall greentic-component -y
          cargo binstall packc -y
          cargo binstall cargo-component -y

      - name: Format check
        run: cargo fmt --check

      - name: Clippy
        run: cargo clippy --workspace --exclude component-dwbase --exclude dwbase-pack-runner -- -D warnings

      - name: Tests
        run: cargo test --workspace --exclude component-dwbase --exclude dwbase-pack-runner

      - name: Install wasm32-wasip2 target
        run: rustup target add wasm32-wasip2

      - name: Build component (wasm32-wasip2)
        run: cargo component build -p component-dwbase --release --target wasm32-wasip2 --features component-wasm

      - name: Stage manifest + hashes
        run: |
          COMPONENT_WASM=target/wasm32-wasip2/release/component_dwbase.wasm
          COMPONENT_MANIFEST=target/wasm32-wasip2/release/component.manifest.json
          cp crates/component-dwbase/component.manifest.json "$COMPONENT_MANIFEST"
          greentic-component hash --wasm "$COMPONENT_WASM" "$COMPONENT_MANIFEST"
          mkdir -p packs/dwbase-gtpack/components
          cp "$COMPONENT_WASM" packs/dwbase-gtpack/components/component_dwbase.wasm
          cp "$COMPONENT_MANIFEST" packs/dwbase-gtpack/components/component.manifest.json

      - name: Build dwbase gtpack
        run: packc build --in packs/dwbase-gtpack --gtpack-out packs/dwbase-gtpack/dist/dwbase.gtpack

      - name: Component doctor
        run: |
          if [ -f target/wasm32-wasip2/release/component.manifest.json ]; then
            greentic-component doctor target/wasm32-wasip2/release/component.manifest.json
          else
            echo "component wasm not found, skipping doctor"
          fi

      - name: Pack verify
        run: |
          MANIFEST=packs/dwbase-gtpack/dist/manifest.cbor
          if [ -f "$MANIFEST" ]; then
            DEV_KEY=packs/dwbase-gtpack/dist/dev-component.key
            DEV_PUB=packs/dwbase-gtpack/dist/dev-component.pub
            openssl genpkey -algorithm Ed25519 -out "$DEV_KEY"
            openssl pkey -in "$DEV_KEY" -pubout -out "$DEV_PUB"
            packc sign --pack packs/dwbase-gtpack --manifest "$MANIFEST" --key "$DEV_KEY" --offline
            packc verify --pack packs/dwbase-gtpack --manifest "$MANIFEST" --key "$DEV_PUB" --offline
          else
            echo "pack manifest not found, skipping packc verify"
          fi

      - name: Schema/manifest sync check
        run: python3 tools/check_schema_sync.py
